# Deployment

__by [Jakob Feistenauer](https://github.com/yescob)__

## Introduction

We have only deployed the platform locally or in a Google Cloud Compute Engine VM with Docker using the provided [`docker-compose`](https://github.com/Layblar/platform/blob/main/deployment/docker-compose.yaml) file.

Our VM settings were the following:

- e2-standart-4
  - vCPU 4
  - 16 GB Memory
  - image: debian-11-bullseye-v20231212
  - 100 GB storage

Additionally make sure to have the following installed on the machine:

- Docker
- Docker-Compose
- Git
- Make
- CURL

For local deployment we used the following Docker Desktop Settings:

- 2 virtual processors
- 8 GB VM memory

## Create a .env file

Created a .env file and fill it with the necessary information. See the [`.exampleenv`](https://github.com/Layblar/platform/tree/main/deployment/.exampleenv) file for what environment variables you have to provide.

The environment variables are for example used to set the password and username for the database:

```yaml
  gateway:
    image: jfe7727/layblar-gateway:main
    depends_on:
      - postgres-gateway
    environment:
      QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://postgres-gateway:5432/layblaruser
      QUARKUS_DATASOURCE_USERNAME: ${GATEWAY_DB_USER}
      QUARKUS_DATASOURCE_PASSWORD: ${GATEWAY_DB_PW}
      QUARKUS_HIBERNATE_ORM_DATABASE_GENERATION: update
      MP_JWT_VERIFY_PUBLICKEY_LOCATION: file:///key/publicKey.pem
      SMALLRYE_JWT_SIGN_KEY_LOCATION: file:///key/privateKey.pem
      MP_JWT_VERIFY_ISSUER: ${JWT_ISSUER}
```

You can change or create your own environment variables. Keep in mind to update the corresponding yaml files.

After you have created the .evn file add it to the [`deployment`](https://github.com/Layblar/platform/tree/main/deployment) folder.

## Getting the keys for JWT RBAC

The Layblar-Platform uses JWT RBAC. Therefore you need an RSA key pair. The public key is required to verify the tokens. The private key is used for the generation and signing of the tokens in the Gateway.

> __NOTE__: Using the OpenSSL command line tool you can generate the necessary keys with these three steps:
>
>```console
>openssl genrsa -out rsaPrivateKey.pem 2048
>openssl rsa -pubout -in rsaPrivateKey.pem -out publicKey.pem
>openssl pkcs8 -topk8 -nocrypt -inform pem -in rsaPrivateKey.pem -outform pem -out privateKey.pem
>```
>
>For more information visit the [Quarkus Documentation for JWT RBAC](https://quarkus.io/guides/security-jwt#configuring-the-smallrye-jwt-extension-security-information)

Then add your private and public keys for the JWT RBAC into the deployment folder.

If your keys are not named `privateKey.pem` and `publicKey.pem` you have to update the following lines of the yaml files of the services:

```yaml
[...]
    volumes:
      - <Path to your public key file>:/key/publicKey.pem
      - <Path to your private key file>:/key/privateKey.pem
[...]
```

> __NOTE__: You can also change the volume location on the docker side. However, then you have to also update the following environment variables:
>
>```yaml
>[...]
>      MP_JWT_VERIFY_PUBLICKEY_LOCATION: file:///key/publicKey.pem
>      SMALLRYE_JWT_SIGN_KEY_LOCATION: file:///key/privateKey.pem
>[...]
>```

## TLS for RabbitMQ

To enable TLS for RabbitMQ we also need some new certificates and keys.
We followed the following guide from RabbitMQ: <https://www.rabbitmq.com/ssl.html> and used tls-gen to created the neccessary files.

> __NOTE__: We had to set the CN name to the host name we have given RabbitMQ in the rabbit.yaml.
>
>```console
>make CN=rabbithostname
>```
>

Copy the result folder generated by tls-gen into the [`rabbitmq`](https://github.com/Layblar/platform/tree/main/deployment/rabbitmq) subfolder of the [`deployment`](https://github.com/Layblar/platform/tree/main/deployment) folder.

The ca_certificate.pem can then be used by clients to connect to RabbitMQ with TLS/SSL.

If you want to change the TLS ports or enable Mutual TLS update the  [`rabbitmq.conf`](https://github.com/Layblar/platform/tree/main/deployment/rabbitmq/rabbitmq.conf) in the subfolder  [`rabbitmq`](https://github.com/Layblar/platform/tree/main/deployment/rabbitmq) and update the ports in the  [`rabbit.yaml`](https://github.com/Layblar/platform/tree/main/deployment/rabbit.yaml)

> __NOTE__: For Mutual TLS you also need a client certificate and key pair.

## Debezium Connector

As the platform uses Debezium for Transaction Log Tailing to send the Events to Kafka  we need to provide configuration files for the connectors.

Currently there needs to be a Connector for the Household database and the Project database.

```yaml
{
    "name": "project-event-connector",
    "config": {
        "connector.class": "io.debezium.connector.postgresql.PostgresConnector",
        "tasks.max": "1",
        "database.hostname": "postgres-project",
        "database.port": "5432",
        "database.user": "project",
        "database.password": "project",
        "database.dbname" : "project",
        "topic.prefix": "project",
        "table.include.list": "public.event",
        "key.converter": "org.apache.kafka.connect.json.JsonConverter",
        "key.converter.schemas.enable": "false",
        "key.converter.json.schemas.enable": "false",
        "key.converter.json.fail.invalid.schema": "false",
        "value.converter": "org.apache.kafka.connect.json.JsonConverter",
        "value.converter.schemas.enable": "false",
        "value.converter.json.schemas.enable": "false",
        "value.converter.json.fail.invalid.schema": "false"
    }
}
```

You have to update the user and password fields to the correct values that you have set in the .env file.

## Deploying with Docker

When deploying on Google Cloud Compute Engine VM you have to copy the folder [`deployment`](https://github.com/Layblar/platform/tree/main/deployment) onto your VM. Ensure that you have all the necessary files.

> __NOTE__: We have created the keys directly on the VM. We recommend this approach.

After you have added the additional files and navigated to the deployment folder deploy the Layblar-Platform by running:

```console
docker compose up
```

> __NOTE__: You can specify the additonal parameter `-d` to execute the command in the background.

Wait for the Kafka Connect Service to be available then execute the following commandos:

```console
curl -i -X POST -H "Accept:application/json" -H  "Content-Type:application/json" http://localhost:8083/connectors/ -d @project-config.json
curl -i -X POST -H "Accept:application/json" -H  "Content-Type:application/json" http://localhost:8083/connectors/ -d @household-config.json
```

This starts the Debezium connector for Transaction Log Tailing. Otherwise no events will be send to Kafka.

> __NOTE__: In some occasions the layblar-smart-meter-service was not able to connect to the TimescaleDB. In that case simply restart the layblar-smart-meter-service.

Now you can access the Layblar-Platform under [http//:HOST:80](http//:localhost:8080).
Visit the [API-Documentation](https://layblar.github.io/platform/apidoc.html) to see which endpoints are availabe.

## Running in development mode

Ensure you meet the following requirements:

- JDK 11+
- Gradle
- Docker Desktop (optional)

Before starting a service in development mode have a look into the `application.properties` file.

```properties
#kafka configuration
%dev.kafka.bootstrap.servers=localhost:9093
mp.messaging.incoming.household.connector=smallrye-kafka
mp.messaging.incoming.household.topic=household.public.event
mp.messaging.incoming.household.auto.offset.reset=earliest
mp.messaging.incoming.household.group.id=project-service-household-consumer

mp.messaging.incoming.project.connector=smallrye-kafka
mp.messaging.incoming.project.topic=project.public.event
mp.messaging.incoming.project.auto.offset.reset=earliest
mp.messaging.incoming.project.group.id=project-service-project-consumer
mp.messaging.incoming.project.failure-strategy=ignore
mp.messaging.incoming.project.broadcast=true

mp.messaging.outgoing.label-event.connector=smallrye-kafka
mp.messaging.outgoing.label-event.topic=label-event

quarkus.datasource.db-kind = postgresql
%dev.quarkus.datasource.username = project
%dev.quarkus.datasource.password = project
%dev.quarkus.datasource.jdbc.url = jdbc:postgresql://localhost:5435/project
quarkus.hibernate-orm.database.generation=update

# jwt key locations
%dev.mp.jwt.verify.publickey.location=publicKey.pem
# jwt issuer
%dev.mp.jwt.verify.issuer=layblar

%dev.quarkus.http.port=8086

# enable tracing
quarkus.datasource.jdbc.telemetry=true
```

Properties with the suffix `%dev` are only in effect when running the application in development mode. For connections like database and kafka make sure that a service is running on the corresponding port or update the configuration property. If you have Docker Desktop installed you can comment out the connection configurations. Quarkus will automatically start docker containers for the services and connect your application to them.

Start the application by running:

```console
./gradlew quarkusDev
```

> __NOTE__: Quarkus offers live-reloading.
